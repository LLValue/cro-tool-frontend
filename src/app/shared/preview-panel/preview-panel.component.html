<div class="preview-panel" [class.sticky]="true" [class.mobile-view]="viewMode === 'mobile'">
  <div class="preview-wrapper" 
       [class.loading]="loading" 
       [class.mobile-view]="viewMode === 'mobile'"
       [class.zoom-fit]="zoomMode === 'fit'"
       [class.zoom-100]="zoomMode === '100%'"
       [class.zoom-75]="zoomMode === '75%'">
    <div class="loading-overlay" *ngIf="loading">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <p>Loading page preview...</p>
    </div>

    <!-- Iframe preview. Mobile: viewport (deviceViewW×deviceViewH) = 430×932 at 100%, scaled by zoom; single scroll inside iframe. -->
    <div class="iframe-container" 
         #iframeContainer
         [class.mobile-view]="viewMode === 'mobile'"
         [style.width.px]="viewMode === 'mobile' && deviceViewW > 0 ? deviceViewW : null"
         [style.height.px]="viewMode === 'mobile' && deviceViewH > 0 ? deviceViewH : null">
      <div class="device-frame" 
           #deviceFrame
           [style.transform]="viewMode === 'mobile' ? 'scale(' + currentScale + ')' : null">
        <iframe 
          *ngIf="useIframe && safeIframeHtml && !loading" 
          #previewIframe
          [srcdoc]="safeIframeHtml" 
          sandbox="allow-same-origin"
          class="preview-iframe"
          [class.mobile-view]="viewMode === 'mobile'"
          tabindex="-1"
          aria-hidden="true"
          (load)="onIframeLoad()"
          frameborder="0">
        </iframe>
        <iframe 
          *ngIf="useIframe && safeIframeUrl && !safeIframeHtml && !loading" 
          #previewIframe
          [src]="safeIframeUrl" 
          class="preview-iframe"
          [class.mobile-view]="viewMode === 'mobile'"
          tabindex="-1"
          aria-hidden="true"
          (load)="onIframeLoad()"
          frameborder="0">
        </iframe>
      </div>
    </div>

    <!-- Div preview -->
    <div 
      *ngIf="!useIframe && previewHtml && !loading" 
      #previewContent
      class="preview-content" 
      [class.mobile-view]="viewMode === 'mobile'"
      [innerHTML]="safePreviewHtml">
    </div>

    <!-- Empty state -->
    <div *ngIf="!previewHtml && !previewUrl && !loading" class="empty-state">
      <mat-icon>visibility_off</mat-icon>
      <p>No preview available</p>
      <p class="hint">Load a page preview to see it here</p>
    </div>
  </div>

  <div class="preview-header-rail">
    <div class="view-mode-toggle">
      <button 
        mat-icon-button 
        [class.active]="viewMode === 'mobile'"
        (click)="setViewMode('mobile')"
        matTooltip="Mobile view">
        <mat-icon>phone_android</mat-icon>
      </button>
      <button 
        mat-icon-button 
        [class.active]="viewMode === 'desktop'"
        (click)="setViewMode('desktop')"
        matTooltip="Desktop view">
        <mat-icon>desktop_windows</mat-icon>
      </button>
    </div>
    <span *ngIf="viewMode === 'mobile'" class="zoom-select-label">Zoom</span>
    <mat-form-field *ngIf="viewMode === 'mobile'" class="zoom-select" appearance="outline" subscriptSizing="dynamic" hideRequiredMarker>
      <mat-select 
        [value]="zoomMode" 
        (valueChange)="setZoomMode($event)"
        [aria-label]="'Zoom: ' + zoomSelectLabel"
        panelClass="zoom-select-panel">
        <mat-select-trigger class="zoom-select-trigger">{{ zoomSelectLabel }}</mat-select-trigger>
        <mat-option value="fit">Fit ({{ fitScalePercent }}%)</mat-option>
        <mat-option value="125%">125%</mat-option>
        <mat-option value="100%">100%</mat-option>
        <mat-option value="75%">75%</mat-option>
        <mat-option value="50%">50%</mat-option>
      </mat-select>
    </mat-form-field>
    <button 
      mat-icon-button 
      (click)="onReload()" 
      matTooltip="Reload page"
      [disabled]="loading">
      <mat-icon>refresh</mat-icon>
    </button>
    <button 
      *ngIf="showReset && originalHtml" 
      mat-icon-button 
      (click)="onReset()" 
      matTooltip="Reset to original"
      [disabled]="loading">
      <mat-icon>restore</mat-icon>
    </button>
  </div>
</div>
