<app-page-header
  title="Activation"
  description="Generate the install snippet, configure scope and anti-flicker, and monitor project status and activity.">
</app-page-header>

<div class="activation-content">
  <form [formGroup]="activationForm" (ngSubmit)="saveActivation()">
    <div class="activation-grid">
      <mat-card class="script-card">
        <mat-card-header>
          <mat-card-title>Script Snippet</mat-card-title>
          <mat-card-subtitle>GTM + Embed</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Script Code</mat-label>
            <textarea 
              matInput 
              formControlName="scriptSnippet" 
              rows="12"
              placeholder="Script will be generated automatically...">
            </textarea>
          </mat-form-field>
          <div class="script-actions">
            <button type="button" mat-button (click)="generateScriptSnippet()">
              <mat-icon>refresh</mat-icon>
              Regenerate
            </button>
            <button type="button" mat-button (click)="copyScript()">
              <mat-icon>content_copy</mat-icon>
              Copy
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="config-card">
        <mat-card-header>
          <mat-card-title>Configuration</mat-card-title>
        </mat-card-header>
        <mat-card-content class="config-card-content">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Scope Type</mat-label>
            <mat-select formControlName="scopeType" (selectionChange)="onScopeTypeChange()">
              <mat-option value="exact">Exact URL</mat-option>
              <mat-option value="pattern">Pattern</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ activationForm.get('scopeType')?.value === 'exact' ? 'Exact URL' : 'URL Pattern' }}</mat-label>
            <input matInput formControlName="scopeValue" placeholder="https://example.com/page">
            <mat-hint>{{ activationForm.get('scopeType')?.value === 'pattern' ? 'Use * for wildcards, e.g., https://example.com/*' : '' }}</mat-hint>
          </mat-form-field>

          <div class="form-row">
            <mat-slide-toggle formControlName="antiFlicker" (change)="onAntiFlickerChange()">
              Anti-flicker
            </mat-slide-toggle>
            <mat-icon matTooltip="Prevents content flash before variants load" class="info-icon">info</mat-icon>
          </div>

          <mat-form-field appearance="outline" class="full-width" *ngIf="activationForm.get('antiFlicker')?.value">
            <mat-label>Max Wait (ms)</mat-label>
            <input matInput type="number" formControlName="maxWait" (change)="onMaxWaitChange()" placeholder="0">
            <mat-hint>Maximum time to wait for script to load (0-10000ms)</mat-hint>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <mat-card class="status-card">
        <mat-card-header>
          <mat-card-title>Status Panel</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="status-display">
            <mat-chip [color]="getStatusColor(activationForm.get('status')?.value)" selected>
              <mat-icon>{{ activationForm.get('status')?.value === 'Live' ? 'check_circle' : activationForm.get('status')?.value === 'Paused' ? 'pause_circle' : 'preview' }}</mat-icon>
              {{ activationForm.get('status')?.value || 'Paused' }}
            </mat-chip>
          </div>
          <mat-divider></mat-divider>
          <div class="status-actions">
            <button type="button" mat-raised-button color="primary" (click)="activateProject()" [disabled]="activationForm.get('status')?.value === 'Live'">
              <mat-icon>play_arrow</mat-icon>
              Activate Project
            </button>
            <button type="button" mat-button (click)="pauseProject()" [disabled]="activationForm.get('status')?.value === 'Paused'">
              <mat-icon>pause</mat-icon>
              Pause Project
            </button>
            <button type="button" mat-button (click)="previewProject()" [disabled]="activationForm.get('status')?.value === 'Preview'">
              <mat-icon>preview</mat-icon>
              Preview
            </button>
          </div>
          <div class="preview-container" *ngIf="isPreviewMode && safePreviewUrl">
            <mat-divider></mat-divider>
            <div class="preview-header">
              <h4>Page Preview</h4>
              <button mat-icon-button (click)="loadPreview()" matTooltip="Reload preview">
                <mat-icon>refresh</mat-icon>
              </button>
            </div>
            <div class="preview-wrapper">
              <iframe 
                [src]="safePreviewUrl" 
                class="preview-iframe"
                tabindex="-1"
                aria-hidden="true"
                (load)="onPreviewIframeLoad()"
                frameborder="0"
                allowfullscreen>
              </iframe>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="activity-card">
        <mat-card-header>
          <mat-card-title>Activity Log</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="activity-list" *ngIf="activityLogs.length > 0">
            <div class="activity-item" *ngFor="let log of activityLogs">
              <div class="activity-icon">
                <mat-icon>{{ log.action === 'activated' ? 'play_arrow' : log.action === 'paused' ? 'pause' : log.action === 'saved' ? 'save' : 'preview' }}</mat-icon>
              </div>
              <div class="activity-content">
                <div class="activity-message">{{ log.message }}</div>
                <div class="activity-time">{{ formatTimestamp(log.timestamp) }}</div>
              </div>
            </div>
          </div>
          <div class="no-activity" *ngIf="activityLogs.length === 0">
            <p>No activity yet</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="form-actions">
      <button type="submit" mat-raised-button color="primary">
        <mat-icon>save</mat-icon>
        Save Configuration
      </button>
    </div>
  </form>
</div>

