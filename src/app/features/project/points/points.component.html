<app-page-header title="Optimization Points">
  <button mat-button (click)="toggleViewMode()">
    <mat-icon>{{ viewMode === 'desktop' ? 'phone_android' : 'desktop_windows' }}</mat-icon>
    {{ viewMode === 'desktop' ? 'Mobile' : 'Desktop' }}
  </button>
</app-page-header>

<div class="points-container">
  <div class="preview-section" [class.mobile]="viewMode === 'mobile'">
    <div class="preview-header">
      <h3>Page Preview</h3>
      <button mat-icon-button (click)="loadPagePreview()" matTooltip="Reload page">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
    <div *ngIf="selectionMode && currentSelector" class="selector-display">
      <div><strong>Selected Text:</strong> <span>{{ selectedText || 'No text' }}</span></div>
      <div><strong>CSS Selector:</strong> <code>{{ currentSelector }}</code></div>
      <div *ngIf="useIframe && !canAccessIframe && selectionMode" class="iframe-warning">
        <mat-icon>warning</mat-icon>
        <span>Cross-origin iframe detected. Cannot select elements directly.</span>
        <div class="iframe-warning-actions">
          <button mat-button (click)="attemptLoadHtmlDirectly()">
            <mat-icon>refresh</mat-icon>
            Try Load HTML
          </button>
          <button mat-raised-button color="primary" (click)="openManualSelectorDialog()">
            <mat-icon>edit</mat-icon>
            Enter Selector Manually
          </button>
        </div>
      </div>
    </div>
    <div #previewContainer class="preview-wrapper" [class.selection-mode]="selectionMode">
      <iframe 
        *ngIf="useIframe && safeIframeUrl" 
        #previewIframe
        [src]="safeIframeUrl" 
        class="preview-iframe"
        frameborder="0"
        (load)="onIframeLoad()">
      </iframe>
      <div 
        *ngIf="!useIframe" 
        class="preview-content" 
        [innerHTML]="safePreviewHtml" 
        (click)="onPreviewClick($event)"
        (mouseover)="onPreviewMouseOver($event)"
        (mouseout)="onPreviewMouseOut($event)">
      </div>
    </div>
    <div *ngIf="selectionMode" class="selection-controls">
      <button mat-button (click)="selectParent()">
        <mat-icon>arrow_upward</mat-icon>
        Parent
      </button>
      <button mat-raised-button color="primary" (click)="confirmSelection()">
        <mat-icon>check</mat-icon>
        Confirm
      </button>
      <button mat-button (click)="cancelSelection()">
        <mat-icon>close</mat-icon>
        Cancel
      </button>
    </div>
  </div>

  <div class="points-list-section">
    <div class="points-header">
      <h3>Points</h3>
      <button mat-raised-button color="primary" (click)="openAddPointDialog()">
        <mat-icon>add</mat-icon>
        Add Point
      </button>
    </div>
    <div *ngIf="points.length === 0" class="empty-points">
      <p>No optimization points yet. Click "Add Point" to create one.</p>
    </div>
    <mat-card *ngFor="let point of points" class="point-card" [class.selected]="selectedPointId === point.id">
      <mat-card-content>
        <strong>{{ point.name }}</strong>
        <p *ngIf="point.text">{{ point.text }}</p>
        <p *ngIf="point.selector"><code>{{ point.selector }}</code></p>
        <p *ngIf="!point.selector" class="no-selector">No selector set</p>
        <div class="card-actions">
          <button mat-icon-button color="warn" (click)="deletePoint(point.id)" matTooltip="Delete point">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

