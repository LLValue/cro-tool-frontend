<h2 mat-dialog-title>
  <mat-icon>edit</mat-icon>
  Create Optimization Point
</h2>

<mat-dialog-content class="editor-content">
  <div class="editor-layout" *ngIf="!loading">
    <div class="preview-section" [class.preview-error]="!!error">
      <div class="preview-header">
        <h3>Page Preview</h3>
        <div class="preview-actions">
          <div class="view-mode-toggle">
            <button 
              mat-icon-button 
              [class.active]="viewMode === 'desktop'"
              (click)="viewMode = 'desktop'"
              matTooltip="Desktop view">
              <mat-icon>desktop_windows</mat-icon>
            </button>
            <button 
              mat-icon-button 
              [class.active]="viewMode === 'mobile'"
              (click)="viewMode = 'mobile'"
              matTooltip="Mobile view">
              <mat-icon>phone_android</mat-icon>
            </button>
          </div>
          <button 
            mat-raised-button 
            color="primary"
            [disabled]="!!error"
            (click)="selectionMode ? disableSelectionMode() : enableSelectionMode()">
            <mat-icon>{{ selectionMode ? 'close' : 'touch_app' }}</mat-icon>
            {{ selectionMode ? 'Cancel Selection' : 'Select Element' }}
          </button>
          <button mat-icon-button (click)="loadPreview()" matTooltip="Refresh preview">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </div>
      
      <div class="preview-wrapper" *ngIf="!error && safeHtml" [class.mobile-view]="viewMode === 'mobile'">
        <iframe 
          #previewFrame
          [srcdoc]="safeHtml"
          class="preview-iframe"
          [class.mobile-view]="viewMode === 'mobile'"
          frameborder="0"
          title="Page Preview">
        </iframe>
      </div>
      
      <div class="preview-error-state" *ngIf="error">
        <mat-icon>error_outline</mat-icon>
        <p class="error-message">{{ error }}</p>
        <button mat-raised-button color="primary" (click)="loadPreview()" class="retry-button">
          <mat-icon>refresh</mat-icon>
          Retry
        </button>
        <p class="error-hint">You can still create a point by entering the CSS selector manually in the form.</p>
      </div>
      
      <p class="help-text" *ngIf="selectionMode && !error">
        <mat-icon>info</mat-icon>
        Hover over elements to highlight them, then click to select.
      </p>
    </div>

    <div class="form-section">
      <h3>Point Details</h3>
      <form [formGroup]="form">
        <mat-form-field appearance="outline" floatLabel="always" class="full-width">
          <input matInput formControlName="name" required placeholder="Enter point name">
          <mat-error *ngIf="form.get('name')?.hasError('required')">
            Name is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" floatLabel="always" class="full-width">
          <mat-select formControlName="elementType" required>
            <mat-option *ngFor="let elementType of elementTypes" [value]="elementType">
              {{ elementType }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" floatLabel="always" class="full-width">
          <input matInput formControlName="selector" required [readonly]="!!selectedElement" placeholder="e.g., .hero-title, #cta-button, h1">
          <mat-hint *ngIf="selectedElement">Generated from selected element</mat-hint>
          <mat-hint *ngIf="!selectedElement">Select an element or enter manually</mat-hint>
          <mat-error *ngIf="form.get('selector')?.hasError('required')">
            Selector is required. Please select an element or enter manually.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" floatLabel="always" class="full-width">
          <textarea matInput formControlName="text" rows="3" [readonly]="!!selectedElement" placeholder="Enter the text content of this element"></textarea>
          <mat-hint *ngIf="selectedElement">Extracted from selected element</mat-hint>
          <mat-hint *ngIf="!selectedElement">Enter the text content of this element</mat-hint>
        </mat-form-field>
      </form>

      <div class="selected-info" *ngIf="selectedElement">
        <mat-icon>check_circle</mat-icon>
        <span>Element selected successfully!</span>
      </div>
    </div>
  </div>

  <div class="loading-overlay" *ngIf="loading">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <p>Loading page preview...</p>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Cancel</button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="onSave()" 
    [disabled]="form.invalid">
    <mat-icon>check</mat-icon>
    Create Point
  </button>
</mat-dialog-actions>

