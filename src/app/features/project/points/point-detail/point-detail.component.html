<app-page-header
  [title]="point?.name || 'Optimization Point'"
  description="Configure this point, write its brief, and manage variants (approve/disable/discard).">
  <button mat-raised-button color="primary" (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
    Back
  </button>
</app-page-header>

<div class="point-detail-container">
  <mat-card class="tabs-card">
    <mat-tab-group>
    <mat-tab label="Point Setup">
      <div class="tab-content">
        <div class="editor-layout" *ngIf="!loading">
          <div class="preview-section" [class.preview-error]="!!error">
            <div class="preview-header">
              <h3>Page Preview</h3>
              <div class="preview-actions">
                <div class="view-mode-toggle">
                  <button 
                    mat-icon-button 
                    [class.active]="viewMode === 'desktop'"
                    (click)="viewMode = 'desktop'"
                    matTooltip="Desktop view">
                    <mat-icon>desktop_windows</mat-icon>
                  </button>
                  <button 
                    mat-icon-button 
                    [class.active]="viewMode === 'mobile'"
                    (click)="viewMode = 'mobile'"
                    matTooltip="Mobile view">
                    <mat-icon>phone_android</mat-icon>
                  </button>
                </div>
                <button 
                  mat-raised-button 
                  color="primary"
                  [disabled]="!!error"
                  (click)="selectionMode ? disableSelectionMode() : enableSelectionMode()">
                  <mat-icon>{{ selectionMode ? 'close' : 'touch_app' }}</mat-icon>
                  {{ selectionMode ? 'Cancel Selection' : 'Select Element' }}
                </button>
                <button mat-icon-button (click)="loadPreview()" matTooltip="Refresh preview">
                  <mat-icon>refresh</mat-icon>
                </button>
              </div>
            </div>
            
            <div class="preview-wrapper" *ngIf="!error && safeHtml" [class.mobile-view]="viewMode === 'mobile'">
              <iframe 
                #previewFrame
                [srcdoc]="safeHtml"
                class="preview-iframe"
                [class.mobile-view]="viewMode === 'mobile'"
                frameborder="0"
                title="Page Preview">
              </iframe>
            </div>
            
            <div class="preview-error-state" *ngIf="error">
              <mat-icon>error_outline</mat-icon>
              <p class="error-message">{{ error }}</p>
              <button mat-raised-button color="primary" (click)="loadPreview()" class="retry-button">
                <mat-icon>refresh</mat-icon>
                Retry
              </button>
              <p class="error-hint">You can still edit the point by entering the CSS selector manually in the form.</p>
            </div>
            
            <p class="help-text" *ngIf="selectionMode && !error">
              <mat-icon>info</mat-icon>
              Hover over elements to highlight them, then click to select.
            </p>
          </div>

          <div class="form-section">
            <h3>Point Details</h3>
            <form [formGroup]="setupForm" (ngSubmit)="saveSetup()">
              <mat-form-field appearance="outline" floatLabel="always" class="full-width">
                <input matInput formControlName="name" required placeholder="Enter point name">
                <mat-error *ngIf="setupForm.get('name')?.hasError('required')">
                  Name is required
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" floatLabel="always" class="full-width">
                <mat-select formControlName="elementType">
                  <mat-option value="Title">Title</mat-option>
                  <mat-option value="CTA">CTA</mat-option>
                  <mat-option value="Subheadline">Subheadline</mat-option>
                  <mat-option value="Microcopy">Microcopy</mat-option>
                  <mat-option value="Other">Other</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" floatLabel="always" class="full-width">
                <input matInput formControlName="selector" required placeholder="e.g., .hero-title, #cta-button, h1">
                <mat-hint *ngIf="selectedElement">Generated from selected element - you can edit it manually</mat-hint>
                <mat-hint *ngIf="!selectedElement">Select an element or enter manually</mat-hint>
                <mat-error *ngIf="setupForm.get('selector')?.hasError('required')">
                  CSS Selector is required
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" floatLabel="always" class="full-width">
                <mat-select formControlName="deviceScope">
                  <mat-option value="All">All</mat-option>
                  <mat-option value="Mobile">Mobile</mat-option>
                  <mat-option value="Desktop">Desktop</mat-option>
                </mat-select>
              </mat-form-field>

              <div class="form-row">
                <mat-slide-toggle 
                  [checked]="setupForm.get('status')?.value === 'Active'"
                  (change)="setupForm.patchValue({ status: $event.checked ? 'Active' : 'Paused' })">
                  {{ setupForm.get('status')?.value === 'Active' ? 'Active' : 'Paused' }}
                </mat-slide-toggle>
              </div>

              <div class="selected-info" *ngIf="selectedElement">
                <mat-icon>check_circle</mat-icon>
                <span>Element selected successfully!</span>
              </div>

              <div class="actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="setupForm.invalid">
                  <mat-icon>save</mat-icon>
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="loading-overlay" *ngIf="loading">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <p>Loading page preview...</p>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Optimization Brief">
      <div class="tab-content">
        <p class="mandatory-note">The mandatory fields are marked with an asterisk *</p>
        <form [formGroup]="briefForm" (ngSubmit)="saveBrief()">
          <!-- Qualitative objective (mandatory) -->
          <div class="form-field-wrapper">
            <label class="field-label">
              Qualitative objective
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Qualitative objective', 'objective')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <p class="field-helper">State the outcome you want this element to drive (e.g., improve clarity, increase trust, drive clicks) in 1â€“2 sentences.</p>
            <mat-form-field appearance="outline" class="brief-input">
              <textarea matInput formControlName="objective" rows="2" placeholder="e.g., Increase trust and reduce perceived risk"></textarea>
              <mat-error *ngIf="briefForm.get('objective')?.hasError('required')">
                Qualitative objective is required
              </mat-error>
              <mat-hint align="end">
                <span *ngIf="getMaxChars() > 0">{{ getCharacterCount('objective') }} / {{ getMaxChars() }} characters</span>
                <span *ngIf="getMaxChars() === 0">{{ getCharacterCount('objective') }} characters</span>
              </mat-hint>
            </mat-form-field>
          </div>

          <!-- Element context (mandatory) -->
          <div class="form-field-wrapper">
            <label class="field-label">
              Element context
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Element context', 'context')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <p class="field-helper">Describe the user mindset and surrounding content so the AI can write copy that fits this exact spot on the page.</p>
            <mat-form-field appearance="outline" class="brief-input">
              <textarea matInput formControlName="context" rows="2" placeholder="Add context about this optimization point" (input)="briefForm.get('context')?.updateValueAndValidity()"></textarea>
              <mat-error *ngIf="briefForm.get('context')?.hasError('required')">
                Element context is required
              </mat-error>
              <mat-hint align="end">
                <span *ngIf="getMaxChars() > 0">{{ getCharacterCount('context') }} / {{ getMaxChars() }} characters</span>
                <span *ngIf="getMaxChars() === 0">{{ getCharacterCount('context') }} characters</span>
              </mat-hint>
            </mat-form-field>
          </div>

          <!-- Good ideas (optional) -->
          <div class="form-field-wrapper">
            <label class="field-label">
              Good ideas
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Good ideas', 'goodIdeas')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <p class="field-helper">List angles or copy patterns you want to explore (e.g., reassurance-first, benefit-first, process clarity, social proof).</p>
            <app-chips-input
              [(ngModel)]="goodIdeas"
              [ngModelOptions]="{standalone: true}"
              label=""
              placeholder="Add good idea">
            </app-chips-input>
          </div>

          <!-- Things to avoid (optional) -->
          <div class="form-field-wrapper">
            <label class="field-label">
              Things to avoid
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Things to avoid', 'thingsToAvoid')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <p class="field-helper">List words, tones, or claims to avoid (e.g., overpromising, jargon, sensitive claims, aggressive urgency).</p>
            <app-chips-input
              [(ngModel)]="thingsToAvoid"
              [ngModelOptions]="{standalone: true}"
              label=""
              placeholder="Add thing to avoid">
            </app-chips-input>
          </div>

          <!-- Must include keywords (optional) -->
          <div class="form-field-wrapper">
            <label class="field-label">
              Must include keywords
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Must include keywords', 'mustIncludeKeywords')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <p class="field-helper">Add any words or phrases that must appear in the variant (use sparingly).</p>
            <app-chips-input
              [(ngModel)]="mustIncludeKeywords"
              [ngModelOptions]="{standalone: true}"
              label=""
              placeholder="Add keyword">
            </app-chips-input>
          </div>

          <!-- Must avoid terms (optional) -->
          <div class="form-field-wrapper">
            <label class="field-label">
              Must avoid terms
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Must avoid terms', 'mustAvoidTerms')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <p class="field-helper">Add words or phrases to avoid for this specific element (in addition to global forbidden terms).</p>
            <app-chips-input
              [(ngModel)]="mustAvoidTerms"
              [ngModelOptions]="{standalone: true}"
              label=""
              placeholder="Add term to avoid">
            </app-chips-input>
          </div>

          <!-- Min chars (optional) -->
          <div class="form-field-wrapper">
            <label class="field-label">
              Min chars
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Min chars', 'minChars')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <p class="field-helper">Set the minimum character length for this element to fit the layout and UX.</p>
            <mat-form-field appearance="outline" class="brief-input-number">
              <input matInput type="number" formControlName="minChars" min="0" placeholder="0">
              <mat-error *ngIf="briefForm.get('minChars')?.hasError('pattern')">
                Only numeric values are allowed
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Max chars (optional) -->
          <div class="form-field-wrapper">
            <label class="field-label">
              Max chars
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Max chars', 'maxChars')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <p class="field-helper">Set the maximum character length for this element to fit the layout and UX.</p>
            <mat-form-field appearance="outline" class="brief-input-number">
              <input matInput type="number" formControlName="maxChars" min="0" placeholder="0">
              <mat-error *ngIf="briefForm.get('maxChars')?.hasError('pattern')">
                Only numeric values are allowed
              </mat-error>
            </mat-form-field>
          </div>

          <div class="actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="briefForm.invalid">
              <mat-icon>save</mat-icon>
              Save
            </button>
          </div>
        </form>
      </div>
    </mat-tab>

    <mat-tab label="Variants">
      <div class="tab-content">
        <div class="variants-header">
          <mat-form-field appearance="outline" floatLabel="always" class="filter-field">
            <mat-select [(ngModel)]="variantFilter" [ngModelOptions]="{standalone: true}" (selectionChange)="filterVariants()">
              <mat-option value="all">All</mat-option>
              <mat-option value="active">Active</mat-option>
              <mat-option value="pending">Pending</mat-option>
              <mat-option value="discarded">Discarded</mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="generateVariants()">
            <mat-icon>auto_awesome</mat-icon>
            Generate Variants
          </button>
        </div>

        <div *ngIf="filteredVariants.length === 0" class="empty-variants">
          <p>No variants found. Click "Generate Variants" to create 10 variants.</p>
        </div>

        <mat-card *ngFor="let variant of filteredVariants" class="variant-card">
          <mat-card-content>
            <div class="variant-header">
              <div class="variant-scores">
                <div class="score">
                  <span class="score-label">UX Score:</span>
                  <span class="score-value">{{ variant.uxScore }}/10</span>
                </div>
                <div class="score">
                  <span class="score-label">Compliance:</span>
                  <span class="score-value">{{ variant.complianceScore }}/10</span>
                </div>
                <mat-chip-set>
                  <mat-chip
                    [class.active]="variant.status === 'active'"
                    [class.pending]="variant.status === 'pending'"
                    [class.discarded]="variant.status === 'discarded'">
                    {{ variant.status }}
                  </mat-chip>
                </mat-chip-set>
              </div>
              <div class="variant-actions">
                <button *ngIf="variant.status !== 'active'" mat-icon-button (click)="approveVariant(variant.id)" matTooltip="Approve">
                  <mat-icon>check_circle</mat-icon>
                </button>
                <button *ngIf="variant.status === 'active'" mat-icon-button (click)="unapproveVariant(variant.id)" matTooltip="Disable">
                  <mat-icon>remove_circle</mat-icon>
                </button>
                <button mat-icon-button color="primary" (click)="deleteVariant(variant.id)" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
            <mat-form-field appearance="outline" floatLabel="always" class="full-width variant-text">
              <textarea 
                matInput 
                [(ngModel)]="variant.text" 
                [ngModelOptions]="{standalone: true}"
                [readonly]="variant.status === 'active'"
                (blur)="updateVariant(variant)"
                rows="2">
              </textarea>
            </mat-form-field>
            <div class="variant-details">
              <p><strong>UX Rationale:</strong> {{ variant.uxRationale }}</p>
              <p><strong>Compliance Rationale:</strong> {{ variant.complianceRationale }}</p>
              <p class="variant-date">Created: {{ formatDate(variant.createdAt) }}</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
    </mat-tab-group>
  </mat-card>

  <div class="bottom-actions">
    <button mat-raised-button color="primary" (click)="toggleStatus()">
      <mat-icon>{{ point?.status === 'Paused' ? 'play_arrow' : 'pause' }}</mat-icon>
      {{ point?.status === 'Paused' ? 'Activate Point' : 'Pause Point' }}
    </button>
  </div>
</div>

