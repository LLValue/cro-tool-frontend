<app-page-header
  [title]="isCreateMode ? 'Create Optimization Point' : ('Optimization Point: ' + (point?.name || 'Unknown'))"
  [description]="isCreateMode ? 'Configure your new optimization point and write its brief.' : 'Configure this point, write its brief, and manage variants (approve/disable/discard).'">
  <button mat-raised-button color="primary" (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
    Back to Points
  </button>
</app-page-header>

<div class="point-detail-container">
  <mat-card class="tabs-card">
    <mat-tab-group>
    <mat-tab label="Point Setup">
      <div class="tab-content">
        <div class="two-column-layout" *ngIf="!loading">
          <div class="left-column">
            <div class="form-section">
              <div class="field-label-row">
                <h3>Point Details</h3>
                <div class="selector-actions">
                  <button 
                    mat-raised-button 
                    color="primary" 
                    type="button" 
                    (click)="toggleSelectionMode()" 
                    [class.active]="selectionMode">
                    <mat-icon>{{ selectionMode ? 'close' : 'touch_app' }}</mat-icon>
                    {{ selectionMode ? 'Cancel Selection' : 'Select Element' }}
                  </button>
                </div>
              </div>
            <form [formGroup]="setupForm" (ngSubmit)="saveSetup()">
              <div class="form-field-wrapper">
                <label class="field-label">
                  Name
                  <span class="required-asterisk">*</span>
                </label>
                <p class="field-helper">Enter a descriptive name for this optimization point.</p>
                <mat-form-field appearance="outline" class="brief-input">
                  <input matInput formControlName="name" required>
                  <mat-error *ngIf="setupForm.get('name')?.hasError('required')">
                    Name is required
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-field-wrapper">
                <label class="field-label">Element type</label>
                <p class="field-helper">Select the type of element you want to optimize.</p>
                <mat-form-field appearance="outline" class="brief-input" floatLabel="always">
                  <mat-select formControlName="elementType">
                    <mat-option *ngFor="let elementType of elementTypes" [value]="elementType">
                      {{ elementType }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="form-field-wrapper">
                <label class="field-label">
                  CSS Selector
                  <span class="required-asterisk">*</span>
                </label>
                <p class="field-helper">Enter the CSS selector for the element (e.g., .hero-title, #cta-button, h1).</p>
                <mat-form-field appearance="outline" class="brief-input">
                  <input matInput formControlName="selector" required>
                  <mat-hint *ngIf="selectedElement">Generated from selected element - you can edit it manually</mat-hint>
                  <mat-hint *ngIf="!selectedElement">Select an element or enter manually</mat-hint>
                  <mat-error *ngIf="setupForm.get('selector')?.hasError('required')">
                    CSS Selector is required
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-field-wrapper">
                <label class="field-label">Device scope</label>
                <p class="field-helper">Select which devices this optimization point applies to.</p>
                <mat-form-field appearance="outline" class="brief-input" floatLabel="always">
                  <mat-select formControlName="deviceScope">
                    <mat-option value="All">All</mat-option>
                    <mat-option value="Mobile">Mobile</mat-option>
                    <mat-option value="Desktop">Desktop</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-slide-toggle 
                  [checked]="setupForm.get('status')?.value === 'Included'"
                  (change)="onStatusToggleChange($event.checked)">
                  {{ setupForm.get('status')?.value === 'Included' ? 'Included' : 'Excluded' }}
                </mat-slide-toggle>
              </div>

              <div class="selected-info" *ngIf="selectedElement">
                <mat-icon>check_circle</mat-icon>
                <span>Element selected successfully!</span>
              </div>

              <div class="actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="setupForm.invalid">
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="right-column">
          <app-preview-panel
            [previewHtml]="html"
            [previewUrl]="projectPageUrl"
            [loading]="loading"
            [useIframe]="true"
            [showReset]="false"
            [selectionMode]="selectionMode"
            (reload)="loadPreview()"
            (elementSelected)="onElementSelected($event)">
          </app-preview-panel>
        </div>
      </div>

      <div class="loading-overlay" *ngIf="loading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>Loading page preview...</p>
      </div>
      </div>
    </mat-tab>

    <mat-tab label="Optimization Brief">
      <div class="tab-content">
        <!-- AI Brief Helper toolbar -->
        <div class="ai-brief-helper-toolbar">
          <div class="ai-brief-helper-heading">
            <h3 class="ai-brief-helper-title">AI brief helper</h3>
            <p class="ai-brief-helper-subtitle">Draft a stronger objective and context for this optimization point.</p>
          </div>
          <div class="ai-brief-helper-actions">
            <button mat-raised-button color="primary" type="button" (click)="requestBriefDraft('suggest')" [disabled]="briefDraftLoading">
              Suggest brief
            </button>
            <button *ngIf="canShowImproveBrief" mat-raised-button color="primary" type="button" (click)="requestBriefDraft('improve')" [disabled]="briefDraftLoading">
              Improve my brief
            </button>
            <button mat-button type="button" (click)="openWhatWillBeFilledModal()">
              What will be filled?
            </button>
          </div>
        </div>

        <p class="mandatory-note">The mandatory fields are marked with an asterisk <span class="asterisk-red">*</span></p>
        <form [formGroup]="briefForm" (ngSubmit)="saveBrief()">
          <!-- Qualitative objective (mandatory) -->
          <div class="form-field-wrapper" [class.brief-field-highlight]="isFieldHighlighted('objective')">
            <label class="field-label">
              <div>
                <span>Qualitative objective <span class="required-asterisk">*</span></span>
                <span class="field-label-right">
                  <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Qualitative objective', 'objective')" matTooltip="More information">
                    <mat-icon>info</mat-icon>
                  </button>
                </span>
              </div>
              <div>
                <span class="brief-badge" *ngIf="getBadgeLabel('objective')" [class]="getBadgeClass('objective')">{{ getBadgeLabel('objective') }}</span>
                <span class="brief-edited" *ngIf="isManualField('objective')">Edited</span>
              </div>
            </label>
            <p class="field-helper">State the outcome you want this element to drive (e.g., improve clarity, increase trust, drive clicks) in 1â€“2 sentences.</p>
            <mat-form-field appearance="outline" class="brief-input">
              <textarea matInput formControlName="objective" rows="2" (input)="onBriefFieldInput('objective')"></textarea>
              <mat-error *ngIf="briefForm.get('objective')?.hasError('required')">
                Qualitative objective is required
              </mat-error>
              <mat-hint align="end">
                <span *ngIf="getMaxChars() > 0">{{ getCharacterCount('objective') }} / {{ getMaxChars() }} characters</span>
                <span *ngIf="getMaxChars() === 0">{{ getCharacterCount('objective') }} characters</span>
              </mat-hint>
            </mat-form-field>
          </div>

          <!-- Element context (mandatory) -->
          <div class="form-field-wrapper" [class.brief-field-highlight]="isFieldHighlighted('context')">
            <label class="field-label">
              <div>
                <span>Element context <span class="required-asterisk">*</span></span>
                <span class="field-label-right">
                  <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Element context', 'context')" matTooltip="More information">
                    <mat-icon>info</mat-icon>
                  </button>
                </span>
              </div>
              <div>
                <span class="brief-badge" *ngIf="getBadgeLabel('context')" [class]="getBadgeClass('context')">{{ getBadgeLabel('context') }}</span>
                <span class="brief-edited" *ngIf="isManualField('context')">Edited</span>
              </div>
            </label>
            <p class="field-helper">Describe the user mindset and surrounding content so the AI can write copy that fits this exact spot on the page.</p>
            <mat-form-field appearance="outline" class="brief-input">
              <textarea matInput formControlName="context" rows="2" (input)="onBriefFieldInput('context'); briefForm.get('context')?.updateValueAndValidity()"></textarea>
              <mat-error *ngIf="briefForm.get('context')?.hasError('required')">
                Element context is required
              </mat-error>
              <mat-hint align="end">
                <span *ngIf="getMaxChars() > 0">{{ getCharacterCount('context') }} / {{ getMaxChars() }} characters</span>
                <span *ngIf="getMaxChars() === 0">{{ getCharacterCount('context') }} characters</span>
              </mat-hint>
            </mat-form-field>
          </div>

          <!-- Good ideas (optional) -->
          <div class="form-field-wrapper" [class.brief-field-highlight]="isFieldHighlighted('goodIdeas')">
            <label class="field-label">
              <div>
                <span>Good ideas</span>
                <span class="field-label-right">
                  <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Good ideas', 'goodIdeas')" matTooltip="More information">
                    <mat-icon>info</mat-icon>
                  </button>
                </span>
              </div>
              <div>
                <span class="brief-badge" *ngIf="getBadgeLabel('goodIdeas')" [class]="getBadgeClass('goodIdeas')">{{ getBadgeLabel('goodIdeas') }}</span>
                <span class="brief-edited" *ngIf="isManualField('goodIdeas')">Edited</span>
              </div>
            </label>
            <p class="field-helper">List angles or copy patterns you want to explore (e.g., reassurance-first, benefit-first, process clarity, social proof).</p>
            <app-chips-input
              [(ngModel)]="goodIdeas"
              [ngModelOptions]="{standalone: true}"
              label=""
              (ngModelChange)="onBriefFieldInput('goodIdeas')"
              >
            </app-chips-input>
          </div>

          <!-- Things to avoid (optional) -->
          <div class="form-field-wrapper" [class.brief-field-highlight]="isFieldHighlighted('thingsToAvoid')">
            <label class="field-label">
              <div>
                <span>Things to avoid</span>
                <span class="field-label-right">
                  <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Things to avoid', 'thingsToAvoid')" matTooltip="More information">
                    <mat-icon>info</mat-icon>
                  </button>
                </span>
              </div>
              <div>
                <span class="brief-badge" *ngIf="getBadgeLabel('thingsToAvoid')" [class]="getBadgeClass('thingsToAvoid')">{{ getBadgeLabel('thingsToAvoid') }}</span>
                <span class="brief-edited" *ngIf="isManualField('thingsToAvoid')">Edited</span>
              </div>
            </label>
            <p class="field-helper">List words, tones, or claims to avoid (e.g., overpromising, jargon, sensitive claims, aggressive urgency).</p>
            <app-chips-input
              [(ngModel)]="thingsToAvoid"
              [ngModelOptions]="{standalone: true}"
              label=""
              (ngModelChange)="onBriefFieldInput('thingsToAvoid')"
              >
            </app-chips-input>
          </div>

          <!-- Must include keywords (optional) -->
          <div class="form-field-wrapper" [class.brief-field-highlight]="isFieldHighlighted('mustIncludeKeywords')">
            <label class="field-label">
              <div>
                <span>Must include keywords</span>
                <span class="field-label-right">
                  <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Must include keywords', 'mustIncludeKeywords')" matTooltip="More information">
                    <mat-icon>info</mat-icon>
                  </button>
                </span>
              </div>
              <div>
                <span class="brief-badge" *ngIf="getBadgeLabel('mustIncludeKeywords')" [class]="getBadgeClass('mustIncludeKeywords')">{{ getBadgeLabel('mustIncludeKeywords') }}</span>
                <span class="brief-edited" *ngIf="isManualField('mustIncludeKeywords')">Edited</span>
              </div>
            </label>
            <p class="field-helper">Add any words or phrases that must appear in the variant (use sparingly).</p>
            <app-chips-input
              [(ngModel)]="mustIncludeKeywords"
              [ngModelOptions]="{standalone: true}"
              label=""
              (ngModelChange)="onBriefFieldInput('mustIncludeKeywords')"
              >
            </app-chips-input>
          </div>

          <!-- Must avoid terms (optional) -->
          <div class="form-field-wrapper" [class.brief-field-highlight]="isFieldHighlighted('mustAvoidTerms')">
            <label class="field-label">
              <div>
                <span>Must avoid terms</span>
                <span class="field-label-right">
                  <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Must avoid terms', 'mustAvoidTerms')" matTooltip="More information">
                    <mat-icon>info</mat-icon>
                  </button>
                </span>
              </div>
              <div>
                <span class="brief-badge" *ngIf="getBadgeLabel('mustAvoidTerms')" [class]="getBadgeClass('mustAvoidTerms')">{{ getBadgeLabel('mustAvoidTerms') }}</span>
                <span class="brief-edited" *ngIf="isManualField('mustAvoidTerms')">Edited</span>
              </div>
            </label>
            <p class="field-helper">Add words or phrases to avoid for this specific element (in addition to global forbidden terms).</p>
            <app-chips-input
              [(ngModel)]="mustAvoidTerms"
              [ngModelOptions]="{standalone: true}"
              label=""
              (ngModelChange)="onBriefFieldInput('mustAvoidTerms')"
              >
            </app-chips-input>
          </div>

          <!-- Min chars (optional) -->
          <div class="form-field-wrapper" [class.brief-field-highlight]="isFieldHighlighted('minChars')">
            <label class="field-label">
              <div>
                <span>Min chars</span>
                <span class="field-label-right">
                  <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Min chars', 'minChars')" matTooltip="More information">
                    <mat-icon>info</mat-icon>
                  </button>
                </span>
              </div>
              <div>
                <span class="brief-badge" *ngIf="getBadgeLabel('minChars')" [class]="getBadgeClass('minChars')">{{ getBadgeLabel('minChars') }}</span>
                <span class="brief-edited" *ngIf="isManualField('minChars')">Edited</span>
              </div>
            </label>
            <p class="field-helper">Set the minimum character length for this element to fit the layout and UX.</p>
            <mat-form-field appearance="outline" class="brief-input-number">
              <input matInput type="number" formControlName="minChars" min="0" (input)="onBriefFieldInput('minChars')">
              <mat-error *ngIf="briefForm.get('minChars')?.hasError('pattern')">
                Only numeric values are allowed
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Max chars (optional) -->
          <div class="form-field-wrapper" [class.brief-field-highlight]="isFieldHighlighted('maxChars')">
            <label class="field-label">
              <div>
                <span>Max chars</span>
                <span class="field-label-right">
                  <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Max chars', 'maxChars')" matTooltip="More information">
                    <mat-icon>info</mat-icon>
                  </button>
                </span>
              </div>
              <div>
                <span class="brief-badge" *ngIf="getBadgeLabel('maxChars')" [class]="getBadgeClass('maxChars')">{{ getBadgeLabel('maxChars') }}</span>
                <span class="brief-edited" *ngIf="isManualField('maxChars')">Edited</span>
              </div>
            </label>
            <p class="field-helper">Set the maximum character length for this element to fit the layout and UX.</p>
            <mat-form-field appearance="outline" class="brief-input-number">
              <input matInput type="number" formControlName="maxChars" min="0" (input)="onBriefFieldInput('maxChars')">
              <mat-error *ngIf="briefForm.get('maxChars')?.hasError('pattern')">
                Only numeric values are allowed
              </mat-error>
            </mat-form-field>
          </div>

          <div class="actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="briefForm.invalid">
              Save
            </button>
          </div>
        </form>
      </div>
    </mat-tab>

    <mat-tab label="Variants">
      <div class="tab-content variants-tab-content">
        <div *ngIf="isCreateMode" class="create-mode-message">
          <mat-card>
            <mat-card-content>
              <div style="text-align: center; padding: 40px;">
                <mat-icon style="font-size: 48px; width: 48px; height: 48px; color: #666; margin-bottom: 16px;">info</mat-icon>
                <h3>Save the point first</h3>
                <p>Please save the Point Setup to create this optimization point before you can generate variants.</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
        <div *ngIf="!isCreateMode" class="two-column-layout">
          <div class="left-column">
            <div class="variants-header">
              <mat-form-field appearance="outline" floatLabel="always" class="filter-field">
                <mat-select [(ngModel)]="variantFilter" [ngModelOptions]="{standalone: true}" (selectionChange)="filterVariants()">
                  <mat-option value="all">All</mat-option>
                  <mat-option value="pending">Pending</mat-option>
                  <mat-option value="approved">Approved</mat-option>
                  <mat-option value="discarded">Discarded</mat-option>
                </mat-select>
              </mat-form-field>
              <div class="variants-actions">
                <button mat-raised-button color="primary" (click)="generateVariants()">
                  <mat-icon>auto_awesome</mat-icon>
                  Generate Variants
                </button>
                <button *ngIf="variants.length > 0" mat-raised-button (click)="deleteAllVariants()">
                  Borrar todas
                </button>
              </div>
            </div>

            <div *ngIf="filteredVariants.length === 0" class="empty-variants">
              <p>No variants found. Click "Generate Variants" to create 10 variants.</p>
            </div>

            <mat-card *ngFor="let variant of filteredVariants" class="variant-card">
              <mat-card-content>
                <div class="variant-header">
                  <div class="variant-scores">
                    <div class="score">
                      <span class="score-label">UX Score:</span>
                      <span class="score-value">{{ variant.uxScore }}/10</span>
                    </div>
                    <div class="score">
                      <span class="score-label">Compliance:</span>
                      <span class="score-value">{{ variant.complianceScore }}/10</span>
                    </div>
                    <mat-chip-set>
                      <mat-chip
                        [class.active]="variant.status === 'approved'"
                        [class.discarded]="variant.status === 'discarded'">
                        {{ variant.status }}
                      </mat-chip>
                    </mat-chip-set>
                  </div>
                  <div class="variant-actions">
                    <button mat-raised-button color="primary" (click)="previewVariant(variant)">
                      <mat-icon>visibility</mat-icon>
                      Preview
                    </button>
                    <button *ngIf="variant.status !== 'approved'" mat-icon-button (click)="approveVariant(variant.id)" matTooltip="Approve">
                      <mat-icon>check_circle</mat-icon>
                    </button>
                    <button *ngIf="variant.status === 'approved'" mat-icon-button (click)="unapproveVariant(variant.id)" matTooltip="Disable">
                      <mat-icon>remove_circle</mat-icon>
                    </button>
                    <button mat-icon-button color="primary" (click)="deleteVariant(variant.id)" matTooltip="Delete">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
                <mat-form-field appearance="outline" floatLabel="always" class="full-width variant-text">
                  <textarea 
                    matInput 
                    [(ngModel)]="variant.text" 
                    [ngModelOptions]="{standalone: true}"
                    [readonly]="variant.status === 'approved'"
                    (blur)="updateVariant(variant)"
                    rows="2">
                  </textarea>
                </mat-form-field>
                <div class="variant-details">
                  <p><strong>UX Rationale:</strong> {{ variant.uxRationale }}</p>
                  <p><strong>Compliance Rationale:</strong> {{ variant.complianceRationale }}</p>
                  <p class="variant-date">Created: {{ formatDate(variant.createdAt) }}</p>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="right-column">
            <app-preview-panel
              [previewHtml]="previewHtml"
              [previewUrl]="previewUrl"
              [loading]="loadingPreview"
              [useIframe]="true"
              [showReset]="true"
              [originalHtml]="originalPreviewHtml"
              [highlightSelector]="highlightSelector"
              (reload)="onPreviewReload()"
              (reset)="onPreviewReset()">
            </app-preview-panel>
          </div>
        </div>
      </div>
    </mat-tab>
    </mat-tab-group>
  </mat-card>

  <div class="bottom-actions" *ngIf="!isCreateMode">
    <button mat-raised-button color="primary" (click)="toggleStatus()">
      <mat-icon>{{ point?.status === 'Excluded' ? 'play_arrow' : 'pause' }}</mat-icon>
      {{ point?.status === 'Excluded' ? 'Include Point' : 'Exclude Point' }}
    </button>
  </div>
</div>

