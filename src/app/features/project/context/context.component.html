<app-page-header
  title="Brief & Guardrails"
  description="Capture the global context, voice, proof points, and guardrails that will guide variant generation across all optimization points.">
</app-page-header>

<!-- AI Briefing Assistant Block -->
<mat-card class="ai-assistant-card" [class.collapsed]="!aiAssistantExpanded">
  <div class="ai-assistant-header" (click)="toggleAiAssistant()">
    <div class="ai-assistant-title-section">
      <h3 class="ai-assistant-title">
        AI Briefing Assistant
        <button mat-icon-button type="button" class="info-icon" (click)="openHowItWorksModal($event); $event.stopPropagation()" matTooltip="How it works" [attr.aria-label]="'How it works'">
          <mat-icon>info</mat-icon>
        </button>
      </h3>
      <p class="ai-assistant-subtitle">Auto-fill your brief from trusted sources (URLs or documents). Review and approve suggestions before using them.</p>
    </div>
    <div class="ai-assistant-actions">
      <button mat-icon-button type="button" [attr.aria-label]="aiAssistantExpanded ? 'Collapse' : 'Expand'">
        <mat-icon>{{ aiAssistantExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
    </div>
  </div>

  <div class="ai-assistant-content" *ngIf="aiAssistantExpanded">
    <form [formGroup]="aiAssistantForm" class="ai-assistant-form">
      <!-- Sources Section -->
      <div class="form-field-wrapper">
        <label class="field-label">
          Sources
        </label>
        <p class="field-helper">Add up to 5 URLs and/or upload documents (PDF). The assistant will summarize and propose draft content for your brief.</p>
        
        <!-- URL Input -->
        <div class="url-input-section">
          <mat-form-field appearance="outline" class="url-input-field">
            <input 
              matInput 
              placeholder="Paste a URL and press Enter (max 5)"
              [formControl]="urlInputControl"
              (keydown.enter)="addUrl($event)">
          </mat-form-field>
        </div>

        <!-- URL Chips -->
        <div class="url-chips" *ngIf="urls.length > 0">
          <mat-chip-set>
            <mat-chip *ngFor="let url of urls; let i = index" (removed)="removeUrl(i)">
              {{ url }}
              <button matChipRemove [attr.aria-label]="'Remove ' + url">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          </mat-chip-set>
        </div>

        <!-- Add URL Button -->
        <div class="upload-section">
          <button mat-raised-button color="primary" type="button" (click)="addUrlFromButton()" [disabled]="urls.length >= 5">
            Add URL
          </button>
        </div>

        <!-- Upload Button -->
        <div class="upload-section">
          <button mat-raised-button color="primary" type="button" (click)="uploadDocument()">
            <mat-icon>upload_file</mat-icon>
            Upload documents
          </button>
          <p class="upload-note">Tip: Use product pages, pricing pages, FAQs, and approved product PDFs.</p>
        </div>

        <!-- Uploaded Files Chips -->
        <div class="uploaded-files" *ngIf="uploadedFiles.length > 0">
          <mat-chip-set>
            <mat-chip *ngFor="let file of uploadedFiles; let i = index" (removed)="removeFile(i)">
              <mat-icon>description</mat-icon>
              {{ file.name }}
              <button matChipRemove [attr.aria-label]="'Remove ' + file.name">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          </mat-chip-set>
        </div>
      </div>

      <!-- Target Language -->
      <div class="form-field-wrapper">
        <label class="field-label">
          Target language
        </label>
        <p class="field-helper">This controls the language of the drafted brief and generated variants.</p>
        <mat-form-field appearance="outline" class="brief-input">
          <mat-select formControlName="targetLanguage">
            <mat-option *ngFor="let locale of locales" [value]="locale.value">
              {{ locale.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <p class="sync-note">Synced with Journey context → Language.</p>
      </div>

      <!-- Section Selection -->
      <div class="form-field-wrapper">
        <label class="field-label">
          What should the assistant fill in?
        </label>
        <p class="field-helper">Choose which sections to draft. You can edit everything afterwards.</p>
        <div class="section-checkboxes">
          <mat-checkbox formControlName="fillBusinessContext" [checked]="true">
            Business context
          </mat-checkbox>
          <mat-checkbox formControlName="fillJourneyContext" [checked]="true">
            Journey context
          </mat-checkbox>
          <mat-checkbox formControlName="fillGuardrails" [checked]="true">
            Guardrails (suggestions + proof points extraction)
          </mat-checkbox>
        </div>
      </div>

      <!-- Actions -->
      <div class="ai-assistant-actions-footer">
        <button mat-raised-button color="primary" type="button" (click)="generateDraftBrief()" [disabled]="urls.length === 0 && uploadedFiles.length === 0">
          Generate draft brief
        </button>
      </div>
    </form>
  </div>
</mat-card>

<mat-card class="tabs-card">
  <mat-tab-group>
    <!-- Business context tab -->
    <mat-tab label="Business context">
      <form [formGroup]="globalForm" class="form-container">
        <p class="mandatory-note">The mandatory fields are marked with an asterisk <span class="asterisk-red">*</span></p>
        

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Product description
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Product description', 'productDescription')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('productDescription')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('productDescription') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('productDescription') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('productDescription') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('productDescription') === 'Missing'">
                <img *ngIf="getFieldBadge('productDescription') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('productDescription') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('productDescription')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('productDescription')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">Describe what the product is, how it works at a high level, and the key features/benefits—avoid listing audience segments here.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('productDescription')">
            <textarea matInput formControlName="productDescription" rows="4" maxlength="5000" (input)="onFieldEdit('productDescription')"></textarea>
            <mat-error *ngIf="(globalForm.get('productDescription')?.touched || businessContextSubmitted) && globalForm.get('productDescription')?.hasError('required')">
              Product description is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('productDescription') }} / {{ getMaxLength('productDescription') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Target audiences
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Target audiences', 'targetAudiences')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('targetAudiences')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('targetAudiences') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('targetAudiences') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('targetAudiences') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('targetAudiences') === 'Missing'">
                <img *ngIf="getFieldBadge('targetAudiences') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('targetAudiences') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('targetAudiences')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('targetAudiences')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">Describe 2–5 audience segments, their goals, and their main concerns—avoid repeating the product definition here.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('targetAudiences')">
            <textarea matInput formControlName="targetAudiences" rows="4" maxlength="5000" (input)="onFieldEdit('targetAudiences')"></textarea>
            <mat-error *ngIf="(globalForm.get('targetAudiences')?.touched || businessContextSubmitted) && globalForm.get('targetAudiences')?.hasError('required')">
              Target audiences is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('targetAudiences') }} / {{ getMaxLength('targetAudiences') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Top value props
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Top value props', 'valueProps')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('valueProps')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('valueProps') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('valueProps') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('valueProps') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('valueProps') === 'Missing'">
                <img *ngIf="getFieldBadge('valueProps') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('valueProps') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('valueProps')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('valueProps')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">List 3–6 key value propositions you want to emphasize.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('valueProps')">
            <textarea matInput formControlName="valueProps" rows="4" maxlength="5000" (input)="onFieldEdit('valueProps')"></textarea>
            <mat-error *ngIf="(globalForm.get('valueProps')?.touched || businessContextSubmitted) && globalForm.get('valueProps')?.hasError('required')">
              Top value props is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('valueProps') }} / {{ getMaxLength('valueProps') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">Top objections</label>
            <div class="field-badges" *ngIf="getFieldBadge('topObjections')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('topObjections') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('topObjections') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('topObjections') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('topObjections') === 'Missing'">
                <img *ngIf="getFieldBadge('topObjections') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('topObjections') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('topObjections')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('topObjections')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">List the main concerns that stop users from applying or moving forward.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('topObjections')">
            <textarea matInput formControlName="topObjections" rows="4" maxlength="5000" (input)="onFieldEdit('topObjections')"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('topObjections') }} / {{ getMaxLength('topObjections') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>
        
        <div class="tab-actions">
          <button mat-raised-button color="primary" (click)="saveBusinessContext()" [disabled]="globalForm.get('productDescription')?.invalid || globalForm.get('targetAudiences')?.invalid || globalForm.get('valueProps')?.invalid">
            Save
          </button>
        </div>
      </form>
    </mat-tab>

    <!-- Journey context tab -->
    <mat-tab label="Journey context">
      <form [formGroup]="globalForm" class="form-container">
        <p class="mandatory-note">The mandatory fields are marked with an asterisk <span class="asterisk-red">*</span></p>
        
        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Language (e.g., es-ES)
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Language', 'language')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('language')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('language') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('language') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('language') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('language') === 'Missing'">
                <img *ngIf="getFieldBadge('language') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('language') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('language')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('language')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">Set the language and locale format for the copy (e.g., en-GB, es-ES).</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('language')">
            <mat-select formControlName="language" (selectionChange)="onFieldEdit('language')">
              <mat-option *ngFor="let locale of locales" [value]="locale.value">
                {{ locale.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="(globalForm.get('language')?.touched || journeyContextSubmitted) && globalForm.get('language')?.hasError('required')">
              Language is required
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Tone and style
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Tone and style', 'toneAndStyle')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('toneAndStyle')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('toneAndStyle') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('toneAndStyle') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('toneAndStyle') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('toneAndStyle') === 'Missing'">
                <img *ngIf="getFieldBadge('toneAndStyle') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('toneAndStyle') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('toneAndStyle')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('toneAndStyle')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">Describe how the brand should sound, with do/don't guidance.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('toneAndStyle')">
            <textarea matInput formControlName="toneAndStyle" rows="4" maxlength="5000" (input)="onFieldEdit('toneAndStyle')"></textarea>
            <mat-error *ngIf="(globalForm.get('toneAndStyle')?.touched || journeyContextSubmitted) && globalForm.get('toneAndStyle')?.hasError('required')">
              Tone and style is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('toneAndStyle') }} / {{ getMaxLength('toneAndStyle') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Page context and goal
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Page context and goal', 'pageContextAndGoal')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('pageContextAndGoal')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('pageContextAndGoal') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('pageContextAndGoal') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('pageContextAndGoal') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('pageContextAndGoal') === 'Missing'">
                <img *ngIf="getFieldBadge('pageContextAndGoal') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('pageContextAndGoal') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('pageContextAndGoal')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('pageContextAndGoal')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">Explain what this page is, what comes before/after, and what action you want.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('pageContextAndGoal')">
            <textarea matInput formControlName="pageContextAndGoal" rows="3" maxlength="5000" (input)="onFieldEdit('pageContextAndGoal')"></textarea>
            <mat-error *ngIf="(globalForm.get('pageContextAndGoal')?.touched || journeyContextSubmitted) && globalForm.get('pageContextAndGoal')?.hasError('required')">
              Page context and goal is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('pageContextAndGoal') }} / {{ getMaxLength('pageContextAndGoal') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Funnel stage and next action
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Funnel stage and next action', 'funnelStageAndNextAction')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('funnelStageAndNextAction')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('funnelStageAndNextAction') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('funnelStageAndNextAction') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('funnelStageAndNextAction') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('funnelStageAndNextAction') === 'Missing'">
                <img *ngIf="getFieldBadge('funnelStageAndNextAction') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('funnelStageAndNextAction') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('funnelStageAndNextAction')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('funnelStageAndNextAction')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">Choose where the user is in the journey and the single action you want them to take next.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('funnelStageAndNextAction')">
            <input matInput formControlName="funnelStageAndNextAction" maxlength="5000" (input)="onFieldEdit('funnelStageAndNextAction')">
            <mat-hint align="end">
              <span>{{ getCharacterCount('funnelStageAndNextAction') }} / {{ getMaxLength('funnelStageAndNextAction') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>
        
        <div class="tab-actions">
          <button mat-raised-button color="primary" (click)="saveJourneyContext()" [disabled]="globalForm.get('language')?.invalid || globalForm.get('toneAndStyle')?.invalid || globalForm.get('pageContextAndGoal')?.invalid">
            Save
          </button>
        </div>
      </form>
    </mat-tab>

    <!-- Guardrails tab -->
    <mat-tab label="Guardrails">
      <form [formGroup]="globalForm" class="form-container">
        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Brand guidelines
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Brand guidelines', 'brandGuidelines')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('brandGuidelines')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('brandGuidelines') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('brandGuidelines') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('brandGuidelines') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('brandGuidelines') === 'Missing'">
                <img *ngIf="getFieldBadge('brandGuidelines') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('brandGuidelines') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('brandGuidelines')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('brandGuidelines')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">Add any brand rules the copy must follow (terminology, formatting, tone boundaries).</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('brandGuidelines')">
            <textarea matInput formControlName="brandGuidelines" rows="4" maxlength="5000" (input)="onFieldEdit('brandGuidelines')"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('brandGuidelines') }} / {{ getMaxLength('brandGuidelines') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Allowed proof points / facts
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Allowed proof points', 'allowedFacts')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('allowedFacts')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('allowedFacts') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('allowedFacts') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('allowedFacts') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('allowedFacts') === 'Missing'">
                <img *ngIf="getFieldBadge('allowedFacts') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('allowedFacts') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('allowedFacts')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('allowedFacts')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">List verified facts the AI is allowed to state as factual claims.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('allowedFacts')">
            <textarea matInput formControlName="allowedFacts" rows="4" maxlength="5000" (input)="onFieldEdit('allowedFacts')"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('allowedFacts') }} / {{ getMaxLength('allowedFacts') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Forbidden words
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Forbidden words', 'forbiddenWords')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('forbiddenWords')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('forbiddenWords') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('forbiddenWords') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('forbiddenWords') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('forbiddenWords') === 'Missing'">
                <img *ngIf="getFieldBadge('forbiddenWords') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('forbiddenWords') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('forbiddenWords')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('forbiddenWords')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">Add words or claims the AI must never use in generated variants.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('forbiddenWords')">
            <textarea matInput formControlName="forbiddenWords" rows="4" maxlength="5000" (input)="onFieldEdit('forbiddenWords')"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('forbiddenWords') }} / {{ getMaxLength('forbiddenWords') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Sensitive claims
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Sensitive claims', 'sensitiveClaims')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('sensitiveClaims')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('sensitiveClaims') === autoFilledLabel"
                    [class.badge-review]="getFieldBadge('sensitiveClaims') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('sensitiveClaims') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('sensitiveClaims') === 'Missing'">
                <img *ngIf="getFieldBadge('sensitiveClaims') === autoFilledLabel" src="assets/icons/ai.svg" class="field-badge-ai-icon" alt="">
                {{ getFieldBadge('sensitiveClaims') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('sensitiveClaims')">Edited</span>
              <mat-icon class="warning-icon" *ngIf="hasFormatIssue('sensitiveClaims')" matTooltip="Format issue detected">warning</mat-icon>
            </div>
          </div>
          <p class="field-helper">List claim categories that require extra caution or manual review.</p>
          <mat-form-field appearance="outline" class="brief-input" [ngClass]="getFieldHighlightClasses('sensitiveClaims')">
            <textarea matInput formControlName="sensitiveClaims" rows="4" maxlength="5000" (input)="onFieldEdit('sensitiveClaims')"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('sensitiveClaims') }} / {{ getMaxLength('sensitiveClaims') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>
        
        <div class="tab-actions">
          <button mat-raised-button color="primary" (click)="saveGuardrails()">
            Save
          </button>
        </div>
      </form>
    </mat-tab>
  </mat-tab-group>
</mat-card>
