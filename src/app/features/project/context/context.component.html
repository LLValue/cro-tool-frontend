<app-page-header
  title="Brief & Guardrails"
  description="Capture the global context, voice, proof points, and guardrails that will guide variant generation across all optimization points.">
</app-page-header>

<!-- AI Briefing Assistant Block -->
<mat-card class="ai-assistant-card" [class.collapsed]="!aiAssistantExpanded">
  <div class="ai-assistant-header" (click)="toggleAiAssistant()">
    <div class="ai-assistant-title-section">
      <h3 class="ai-assistant-title">AI Briefing Assistant</h3>
      <p class="ai-assistant-subtitle">Auto-fill your brief from trusted sources (URLs or documents). Review and approve suggestions before using them.</p>
    </div>
    <div class="ai-assistant-actions">
      <button mat-button color="primary" (click)="openHowItWorksModal($event)" type="button">
        How it works
      </button>
      <button mat-icon-button type="button" [attr.aria-label]="aiAssistantExpanded ? 'Collapse' : 'Expand'">
        <mat-icon>{{ aiAssistantExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
      </button>
    </div>
  </div>

  <div class="ai-assistant-content" *ngIf="aiAssistantExpanded">
    <form [formGroup]="aiAssistantForm" class="ai-assistant-form">
      <!-- Sources Section -->
      <div class="form-field-wrapper">
        <label class="field-label">
          Sources
        </label>
        <p class="field-helper">Add up to 5 URLs and/or upload documents (PDF). The assistant will summarize and propose draft content for your brief.</p>
        
        <!-- URL Input -->
        <div class="url-input-section">
          <mat-form-field appearance="outline" class="url-input-field">
            <input 
              matInput 
              [formControl]="urlInputControl"
              (keydown.enter)="addUrl($event)"
              [disabled]="urls.length >= 5">
          </mat-form-field>
          <button mat-stroked-button type="button" (click)="addUrlFromButton()" [disabled]="urls.length >= 5">
            Add URL
          </button>
        </div>

        <!-- URL Chips -->
        <div class="url-chips" *ngIf="urls.length > 0">
          <mat-chip-set>
            <mat-chip *ngFor="let url of urls; let i = index" (removed)="removeUrl(i)">
              {{ url }}
              <button matChipRemove [attr.aria-label]="'Remove ' + url">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          </mat-chip-set>
        </div>

        <!-- Upload Button -->
        <div class="upload-section">
          <button mat-stroked-button type="button" (click)="uploadDocument()">
            <mat-icon>upload_file</mat-icon>
            Upload documents
          </button>
          <p class="upload-note">Tip: Use product pages, pricing pages, FAQs, and approved product PDFs.</p>
        </div>

        <!-- Uploaded Files Chips -->
        <div class="uploaded-files" *ngIf="uploadedFiles.length > 0">
          <mat-chip-set>
            <mat-chip *ngFor="let file of uploadedFiles; let i = index" (removed)="removeFile(i)">
              <mat-icon>description</mat-icon>
              {{ file.name }}
              <button matChipRemove [attr.aria-label]="'Remove ' + file.name">
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          </mat-chip-set>
        </div>
      </div>

      <!-- Target Language -->
      <div class="form-field-wrapper">
        <label class="field-label">
          Target language
        </label>
        <p class="field-helper">This controls the language of the drafted brief and generated variants.</p>
        <mat-form-field appearance="outline" class="brief-input">
          <mat-select formControlName="targetLanguage">
            <mat-option *ngFor="let locale of locales" [value]="locale.value">
              {{ locale.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <p class="sync-note">Synced with Journey context → Language.</p>
      </div>

      <!-- Section Selection -->
      <div class="form-field-wrapper">
        <label class="field-label">
          What should the assistant fill in?
        </label>
        <p class="field-helper">Choose which sections to draft. You can edit everything afterwards.</p>
        <div class="section-checkboxes">
          <mat-checkbox formControlName="fillBusinessContext" [checked]="true">
            Business context
          </mat-checkbox>
          <mat-checkbox formControlName="fillJourneyContext" [checked]="true">
            Journey context
          </mat-checkbox>
          <mat-checkbox formControlName="fillGuardrails" [checked]="true">
            Guardrails (suggestions + proof points extraction)
          </mat-checkbox>
        </div>
      </div>

      <!-- Actions -->
      <div class="ai-assistant-actions-footer">
        <button mat-raised-button color="primary" type="button" (click)="generateDraftBrief()" [disabled]="urls.length === 0 && uploadedFiles.length === 0">
          Generate draft brief
        </button>
        <button mat-button type="button" (click)="clearSources()">
          Clear sources
        </button>
      </div>
    </form>
  </div>
</mat-card>

<mat-card class="tabs-card">
  <mat-tab-group>
    <!-- Business context tab -->
    <mat-tab label="Business context">
      <form [formGroup]="globalForm" class="form-container">
        <p class="mandatory-note">The mandatory fields are marked with an asterisk <span class="asterisk-red">*</span></p>
        

        <div class="form-field-wrapper">
          <div class="field-label-row">
            <label class="field-label">
              Product description
              <span class="required-asterisk">*</span>
              <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Product description', 'productDescription')" matTooltip="More information">
                <mat-icon>info</mat-icon>
              </button>
            </label>
            <div class="field-badges" *ngIf="getFieldBadge('productDescription')">
              <span class="field-badge" [class.badge-draft]="getFieldBadge('productDescription') === 'Auto-filled (Draft)'"
                    [class.badge-review]="getFieldBadge('productDescription') === 'Needs review'"
                    [class.badge-manual]="getFieldBadge('productDescription') === 'Manual'"
                    [class.badge-missing]="getFieldBadge('productDescription') === 'Missing'">
                {{ getFieldBadge('productDescription') }}
              </span>
              <span class="field-badge-edited" *ngIf="hasFieldBeenEdited('productDescription')">Edited</span>
            </div>
          </div>
          <p class="field-helper">Describe what the product is, how it works at a high level, and the key features/benefits—avoid listing audience segments here.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="productDescription" rows="4" maxlength="5000" (input)="onFieldEdit('productDescription')"></textarea>
            <mat-error *ngIf="(globalForm.get('productDescription')?.touched || businessContextSubmitted) && globalForm.get('productDescription')?.hasError('required')">
              Product description is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('productDescription') }} / {{ getMaxLength('productDescription') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">
            Target audiences
            <span class="required-asterisk">*</span>
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Target audiences', 'targetAudiences')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">Describe 2–5 audience segments, their goals, and their main concerns—avoid repeating the product definition here.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="targetAudiences" rows="4" maxlength="5000"></textarea>
            <mat-error *ngIf="(globalForm.get('targetAudiences')?.touched || businessContextSubmitted) && globalForm.get('targetAudiences')?.hasError('required')">
              Target audiences is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('targetAudiences') }} / {{ getMaxLength('targetAudiences') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">
            Top value props
            <span class="required-asterisk">*</span>
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Top value props', 'valueProps')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">List 3–6 key value propositions you want to emphasize.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="valueProps" rows="4" maxlength="5000"></textarea>
            <mat-error *ngIf="(globalForm.get('valueProps')?.touched || businessContextSubmitted) && globalForm.get('valueProps')?.hasError('required')">
              Top value props is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('valueProps') }} / {{ getMaxLength('valueProps') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">Top objections</label>
          <p class="field-helper">List the main concerns that stop users from applying or moving forward.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="typicalObjections" rows="4" maxlength="5000"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('typicalObjections') }} / {{ getMaxLength('typicalObjections') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>
        
        <div class="tab-actions">
          <button mat-raised-button color="primary" (click)="saveBusinessContext()" [disabled]="globalForm.get('productDescription')?.invalid || globalForm.get('targetAudiences')?.invalid || globalForm.get('valueProps')?.invalid">
            Save
          </button>
        </div>
      </form>
    </mat-tab>

    <!-- Journey context tab -->
    <mat-tab label="Journey context">
      <form [formGroup]="globalForm" class="form-container">
        <p class="mandatory-note">The mandatory fields are marked with an asterisk <span class="asterisk-red">*</span></p>
        
        <div class="form-field-wrapper">
          <label class="field-label">
            Language (e.g., es-ES)
            <span class="required-asterisk">*</span>
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Language', 'language')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">Set the language and locale format for the copy (e.g., en-GB, es-ES).</p>
          <mat-form-field appearance="outline" class="brief-input">
            <input matInput formControlName="language" required maxlength="50">
            <mat-error *ngIf="(globalForm.get('language')?.touched || journeyContextSubmitted) && globalForm.get('language')?.hasError('required')">
              Language is required
            </mat-error>
            <mat-error *ngIf="(globalForm.get('language')?.touched || journeyContextSubmitted) && globalForm.get('language')?.hasError('maxlength')">
              Language must be 50 characters or less
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('language') }} / {{ getMaxLength('language') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">
            Tone and style
            <span class="required-asterisk">*</span>
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Tone and style', 'toneAndStyle')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">Describe how the brand should sound, with do/don't guidance.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="toneAndStyle" rows="4" maxlength="5000"></textarea>
            <mat-error *ngIf="(globalForm.get('toneAndStyle')?.touched || journeyContextSubmitted) && globalForm.get('toneAndStyle')?.hasError('required')">
              Tone and style is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('toneAndStyle') }} / {{ getMaxLength('toneAndStyle') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">
            Page context and goal
            <span class="required-asterisk">*</span>
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Page context and goal', 'pageContextAndGoal')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">Explain what this page is, what comes before/after, and what action you want.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="pageContextAndGoal" rows="3" maxlength="5000"></textarea>
            <mat-error *ngIf="(globalForm.get('pageContextAndGoal')?.touched || journeyContextSubmitted) && globalForm.get('pageContextAndGoal')?.hasError('required')">
              Page context and goal is required
            </mat-error>
            <mat-hint align="end">
              <span>{{ getCharacterCount('pageContextAndGoal') }} / {{ getMaxLength('pageContextAndGoal') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">Funnel stage and next action</label>
          <p class="field-helper">Choose where the user is in the journey and the single action you want them to take next (one short line).</p>
          <div class="form-row">
            <div class="form-field-wrapper half-width">
              <mat-form-field appearance="outline" class="brief-input" floatLabel="always">
                <mat-select formControlName="funnelStage">
                  <mat-option value="discovery">Discovery</mat-option>
                  <mat-option value="consideration">Consideration</mat-option>
                  <mat-option value="conversion">Conversion</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="form-field-wrapper half-width">
              <mat-form-field appearance="outline" class="brief-input">
                <textarea matInput formControlName="nextAction" rows="2" maxlength="5000"></textarea>
                <mat-hint align="end">
                  <span>{{ getCharacterCount('nextAction') }} / {{ getMaxLength('nextAction') }}</span>
                </mat-hint>
              </mat-form-field>
            </div>
          </div>
        </div>
        
        <div class="tab-actions">
          <button mat-raised-button color="primary" (click)="saveJourneyContext()" [disabled]="globalForm.get('language')?.invalid || globalForm.get('toneAndStyle')?.invalid || globalForm.get('pageContextAndGoal')?.invalid">
            Save
          </button>
        </div>
      </form>
    </mat-tab>

    <!-- Guardrails tab -->
    <mat-tab label="Guardrails">
      <form [formGroup]="globalForm" class="form-container">
        <div class="form-field-wrapper">
          <label class="field-label">
            Brand guidelines
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Brand guidelines', 'brandGuidelines')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">Add any brand rules the copy must follow (terminology, formatting, tone boundaries).</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="brandGuidelines" rows="4" maxlength="5000"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('brandGuidelines') }} / {{ getMaxLength('brandGuidelines') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">
            Allowed proof points / facts
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Allowed proof points', 'allowedFacts')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">List verified facts the AI is allowed to state as factual claims.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="allowedFacts" rows="4" maxlength="5000"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('allowedFacts') }} / {{ getMaxLength('allowedFacts') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">
            Forbidden words and claims
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Forbidden words and claims', 'forbiddenWordsAndClaims')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">Add words or claims the AI must never use in generated variants.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="forbiddenWordsAndClaims" rows="4" maxlength="5000"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('forbiddenWordsAndClaims') }} / {{ getMaxLength('forbiddenWordsAndClaims') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>

        <div class="form-field-wrapper">
          <label class="field-label">
            Sensitive claims
            <button mat-icon-button type="button" class="info-icon" (click)="openInfoModal('Sensitive claims', 'sensitiveClaims')" matTooltip="More information">
              <mat-icon>info</mat-icon>
            </button>
          </label>
          <p class="field-helper">List claim categories that require extra caution or manual review.</p>
          <mat-form-field appearance="outline" class="brief-input">
            <textarea matInput formControlName="sensitiveClaims" rows="4" maxlength="5000"></textarea>
            <mat-hint align="end">
              <span>{{ getCharacterCount('sensitiveClaims') }} / {{ getMaxLength('sensitiveClaims') }}</span>
            </mat-hint>
          </mat-form-field>
        </div>
        
        <div class="tab-actions">
          <button mat-raised-button color="primary" (click)="saveGuardrails()">
            Save
          </button>
        </div>
      </form>
    </mat-tab>
  </mat-tab-group>
</mat-card>
